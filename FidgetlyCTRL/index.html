<!DOCTYPE html>
<html>
<head>
    <title>Fidgetly CTRL Data Visualizer</title>
    <style>
        body{
            font-family: Helvetica;
            text-align:center;
        }
        ol{
            width:400px;
            text-align:left;
            margin:0 auto;
        }
    </style>
</head>
<body>
    <h1>Fidgetly CTRL Data Visualizer</h1>
        Click here: <button id="connect">Connect</button>
    
    <script>
        //BLE
        let service = '78adb061-470e-405d-a44d-817e559c8839';
        let characteristic  = 'e779f296-27f6-461b-8f96-6b0c3804bfc3';
        let byteLength      = 44;

        let revs = 0;
        let acc = [0.0,0.0,0.0];
        let ang = [0,0,0];
        let sc = 0;
        let nu = 0;
        let orientation = "";
        let spinDirection = "notSpinning";

        window.onload = () => {
            document.getElementById('connect').onclick = connectBLE;
        }

        function connectBLE(){
            //BLE setup. Connect and get service/characteristic notifications
            console.log('Calling requestDevice.');
            navigator.bluetooth.requestDevice({
            	filters: [
                    {namePrefix: 'Fidgetly'},
                    {services: [service]}
                ]
            })
            .then(device => device.gatt.connect())
            .then(server => server.getPrimaryService(service))
            .then(service => service.getCharacteristic(characteristic))
            .then(characteristic => {
                return characteristic.startNotifications()
                .then(_ => {
                    characteristic.addEventListener('characteristicvaluechanged',
                                    handleCharacteristicValueChanged);
                });
            })
            .then(_ => {
                console.log('Notifications have been started.');
            })
            .catch(error => { console.log(error); });

            function handleCharacteristicValueChanged(event){
                var buffer = event.target.value.buffer;
                var view = new DataView(buffer);
                
                revs = view.getInt32(0, true);
                acc = [normalizeAcceleration(view.getInt32(4, true)), normalizeAcceleration(view.getInt32(8, true)), normalizeAcceleration(view.getInt32(12, true))];
                ang = [normalizeGyro(view.getInt32(16, true)), normalizeGyro(view.getInt32(20, true)), normalizeGyro(view.getInt32(24, true))];
                sc = view.getInt16(28, true);
                da = getAngleFromAccelerometerZ(acc[2]);
                orientation = getOrientationFromDeviceAngle(da);
                spinDirection = getSpinDirectionFromGyroZ(ang[2]);

                document.getElementById("revs").innerHTML = "Revs: " + revs;
                document.getElementById("acc").innerHTML = "Acceleration mG: " + acc;
                document.getElementById("ang").innerHTML = "Angular Rate: " + ang;
                document.getElementById("sc").innerHTML = "Spin Count: " + sc;
                document.getElementById("orientation").innerHTML = "Orientation: " + orientation;
                document.getElementById("spinDirection").innerHTML = "Spin Direction: " + spinDirection;
            }
        }


        function normalizeAcceleration(value){
            return value.toPrecision() / 1000.0;
        }

        function normalizeGyro(value){
            return value / 1000;
        }

        function getAngleFromAccelerometerZ(accZ){
            accZ = Math.round(accZ * 10) / 10;
            if (accZ > 1.0){
                accZ = 1.0;
            } else if (accZ < -1.0){
                accZ = -1.0;
            }
            return accZ;
        }

        function getOrientationFromDeviceAngle(angle){
            if (angle > 0 ) {
                return "facingDown";
            } else {
                return "facingUp";
            }
        }

        function getSpinDirectionFromGyroZ(gyroZ){
            if(gyroZ >= 10){
                return "clockwise";
            } else if(gyroZ <= -10){
                return "counterClockwise";
            } else {
                return "notSpinning";
            }
        }

        function toShort(src, startIndex){
            startIndex = startIndex || 0;
            return ((src[startIndex] << 8 | src[startIndex + 1]) << 16) >> 16;
        }

        function toInteger(src, startIndex){
            startIndex = startIndex || 0;
            return src[startIndex] << 24
            | src[startIndex + 1] << 16
            | src[startIndex + 2] << 8
            | src[startIndex + 3];
        }


    </script>

<p id="revs">Revs: ...</p>
<p id="acc">Acceleration mG: ...</p>
<p id="ang">Angular Rate: ...</p>
<p id="sc">Spin Count: ...</p> 
<p id="orientation">Orientation: ...</p> 
<p id="spinDirection">Spin Direction: ...</p> 



</body>
</html>
